<script src="js/jsOTP.min.js"></script>
<script>
    const keyList = document.getElementById("keyList");
    const accountNameInput = document.getElementById("accountName");
    const secretKeyInput = document.getElementById("secretKey");
    const addKeyButton = document.getElementById("addKey");
    const timerDisplay = document.getElementById("timer");

    let countdown = 30;

    function isValid(secret) {
        // Remove spaces and normalize to uppercase before validation
        secret = secret.replace(/\s+/g, '').toUpperCase();
        return /^[A-Z2-7]{16,32}$/.test(secret);
    }

    function saveKeys(keys) {
        localStorage.setItem("2faKeys", JSON.stringify(keys));
    }

    function getKeys() {
        const keys = localStorage.getItem("2faKeys");
        return keys ? JSON.parse(keys) : [];
    }

    function generateCode(secret) {
        const totp = new jsOTP.totp();
        // Remove spaces before generating the OTP
        secret = secret.replace(/\s+/g, '');
        return totp.getOtp(secret);
    }

    function renderKeys() {
        keyList.innerHTML = "";
        const keys = getKeys();

        keys.forEach((key, index) => {
            const listItem = document.createElement("li");
            listItem.className = "key-list-item";

            const code = isValid(key.secret) ? generateCode(key.secret) : "Invalid Key";

            listItem.innerHTML = `
                <div class="key-header">
                    <strong>${key.name}</strong>
                    <button class="delete-btn" onclick="deleteKey(${index})">Delete</button>
                </div>
                <div>
                    <p>Current Code:</p>
                    <div style="display: flex; align-items: center; gap: 0.5rem;">
                        <span id="code-${index}" style="font-weight: bold; font-size: 1.2rem;">${code}</span>
                        <button class="copy-btn" onclick="copyCode(${index})">Copy</button>
                    </div>
                </div>
            `;

            keyList.appendChild(listItem);

            
            if (isValid(key.secret)) {
                setInterval(() => {
                    document.getElementById(`code-${index}`).textContent = generateCode(key.secret);
                }, 30000);
            }
        });
    }

    function copyCode(index) {
        const code = document.getElementById(`code-${index}`).textContent;
        navigator.clipboard.writeText(code).then(() => {
            alert("Code copied to clipboard!");
        }).catch(err => {
            console.error("Failed to copy code: ", err);
        });
    }

    function deleteKey(index) {
        const keys = getKeys();
        keys.splice(index, 1);
        saveKeys(keys);
        renderKeys();
    }

    addKeyButton.addEventListener("click", () => {
        const name = accountNameInput.value.trim();
        const secret = secretKeyInput.value.trim();

        if (!name || !secret) {
            alert("Both account name and secret key are required!");
            return;
        }

        if (!isValid(secret)) {
            alert("Invalid 2FA secret key!");
            return;
        }

        const keys = getKeys();
        keys.push({ name, secret });
        saveKeys(keys);

        accountNameInput.value = "";
        secretKeyInput.value = "";

        renderKeys();
    });

    
    setInterval(() => {
        countdown -= 1;
        if (countdown <= 0) {
            countdown = 30;
            renderKeys();
        }
        timerDisplay.textContent = countdown;
    }, 1000);

    
    renderKeys();
</script>
